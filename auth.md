# Auth Server API

<!-- Questions/Actions
- How do we get API keys for users like apipe-tester where we don't know their
  passwords?
-->

The auth server is responsible both for authenticating users and for deciding
what users and services may access what content.  It is designed using
[OAuth 2.0][1], which is widely used across the internet to secure user facing
and back end services.  It is therefore necessary to reference the OAuth 2.0
specification for additional details not provided in this document.

Usage of OAuth 2.0 requires extensive use of TLS, so the auth server and all
clients should use HTTPS as the only protocol for accessing resources.


## Definitions

- API key: A unique, randomly-generated id that is created by the Auth Server
  and is used both to identify and to authenticate a user.
- user role: A label that represents a subset of the permissions available to a
  user.

Additional important terms are defined in the
[OAuth 2.0 RFC][1] and in the [OAuth 2.0 Bearer Token RFC][2].


## API Keys

A user may only have one active API Key at a time.  API keys may have different
expiration durations.  The storage and access of the user's current API key is
up to the SDK.

API keys should be transmitted in the `Authorization` header of requests:

    Authorization: API-Key 0123456789abcdef

where `0123456789abcdef` is an example API key.


## Authentication API

This part of the API is primarily specified by the [OAuth 2.0 RFC][1].  This
section exists to clarify the necessary endpoints and feature support required
for PTero.

### GET /authorization

This is the "Authorization Endpoint" specified in section 3.1 of the
[OAuth 2.0 RFC][1].  Clients should redirect user agents to this endpoint to
request access tokens.  The auth server must support the "Authorization Code
Grant" and "Implicit Grant" as specified in section 4 of the
[OAuth 2.0 RFC][1].

As an optimization, the auth server should check for the existence of the
`Authorization` header before performing any potentially time-consuming
actions, such as querying the database to verify the `client_id`.

Query string parameters:

- `client_id`
    - string
    - generated by the auth server when the client was registered
    - required
- `redirect_uri`
    - uri
    - must be a valid `redirect_uri` for the client associated with `client_id`
    - required
- `response_type`
    - must be either:  `code`, `token`
    - required
- `state`
    - opaque value generated by the client to prevent
      [cross-site scripting attacks](
      https://en.wikipedia.org/wiki/Cross-site_scripting)
    - required
- `scope`
    - string (space delimited list)
    - optional

Additional query string parameters must be ignored, as per the [OAuth RFC][1].

If the credentials (API key or Basic authentication) supplied in the
`Authorization` header successfully validate against the requested `scope` and
`client_id` (along with any additional validation specified in the
[OAuth RFC][1]), then the services should respond with 302 (Found) including an
`authorization_code` or `access_token` depending on the specified
`response_type`.

Each `access_token` created using the "Implicit Grant" method should have a
short lifetime of at most a few minutes.  As specified in the [OAuth RFC][1],
each `authorization_code` should have a short lifetime of at most a few minutes
and must be usable no more than once.

#### Responses

Success:

- HTTP 302 (Found)
    - if `response_type` is `code`: respond with an `authorization_code`
    - if `response_type` is `token`: respond with an `access_token`
    - The user agent will need to inspect the `Location` header to determine
      whether there is a fragment containing an `access_token`.

Error:

- HTTP 302 (Found)
    - This code is used to communicate errors back to the client.  The client
      may then display more appropriate error messages to the user or decide to
      take different action such as trying to obtain different authorization.
    - if `response_type` is `code`: enumerated errors from section
      4.1.2.1 of [RFC 6749][1]
    - if `response_type` is `token`: enumerated errors from section
      4.2.2.1 of [RFC 6749][1]
- HTTP 400 (Bad Request)
    - The `redirect_uri` specified was invalid.  The user agent should consider
      that the client could be compromised.
- HTTP 401 (Unauthorized)
    - This indicates that the user agent should retry the request with
      credentials.
    - Includes the header `WWW-Authenticate: API-Key`.
    - Includes the header `WWW-Authenticate: Basic`.

### POST /tokens

This is the "Token Endpoint" specified in section 3.2 of the
[OAuth 2.0 RFC][1].  Requires [HTTP Basic authentication][3] of the client
using `client_id` and `client_secret`.  Used by clients to acquire an access
tokens.

This endpoint must support `access_token` creation based on an
`authorization_code` generated by the `/authorization` endpoint or based on a
`refresh_token` generated by the `/tokens` endpoint.

The server must support getting an `access_token` based on a `refresh_token`
with reduced `scope`.  Creating an `access_token` with reduced `scope` should
not invalidate other any other `access_token` with a different `scope`.

The request must be `Content-Type: application/x-www-form-urlencoded`,
with parameters described below:

- `grant_type`
    - Must be one of:  `authorization_code`, `refresh_token`
    - required
- `code`
    - authorization code generated by auth server, and given to client via user
      agent
    - required if `grant_type` is `authorization_code`
    - ignored if `grant_type` is `refresh_token`
- `redirect_uri`
    - the same `redirect_uri` used in the original request
    - required if `grant_type` is `authorization_code`
    - ignored if `grant_type` is `refresh_token`
- `refresh_token`
    - refresh token generated by the auth server
    - required if `grant_type` is `refresh_token`
- `scope`
    - space delimited list
    - optional if `grant_type` is `refresh_token`
        - if omitted when `grant_type` is `refresh_token`, the entire `scope`
          of the `refresh_token` will be used
    - ignored if `grant_type` is `authorization_code`

#### Responses

Success:

- HTTP 200 (OK)
    - Content as described in section 4.1.4 and 5.1 of the [OAuth 2.0 RFC][1].

Error:

- HTTP 400 (Bad Request)
    - Contains additional information as specified in section 5.2 [RFC 6749][1].
- HTTP 401 (Unauthorized)
    - Given when the `Authorization` header is not present.
    - Includes the header `WWW-Authenticate: Basic`


## Authorization API

This portion of the API is provided to clients for answering questions about
whether particular `access_token` is to be allowed to perform actions or view
resources.

### POST /validate

Requires [HTTP Basic authentication][3] of the client using `client_id` and
`client_secret`.  Used by clients to query whether a particular `access_token`
is associated with a particular set of user roles and whether it has a
particular `scope`.

The request body is a JSON dictionary with the following parameters:

- `scopes`
    - list of strings (note that `scope` is a space delimited list)
    - If the `access_token` is not associated with a superset of the scopes in
      this list, then respond with 400 (Bad Request).
- `access_token`
    - The Bearer token that is the subject of the validation query.
- `user_roles`
    - list of strings
    - If the `access_token` is associated with a user that does not have any of
      the roles in the list, then respond with 400 (Bad Request).

#### Responses

Success:

- HTTP 200 (OK)

Error:

- HTTP 400 (Bad Request)
    - possible causes:
        - token is expired
        - required scope not met
        - required user roles not met
        - invalid token (not just expired)
        - invalid request body
- HTTP 401 (Unauthenticated)
    - Includes the header `WWW-Authenticate: Basic`.
- HTTP 403 (Not Authorized)
    - Invalid `Authorization` header.

### GET /user-roles
Responds with the user roles associated with a particular `access_token`.
Requires [HTTP Basic authentication][3] of the client.  This would be used, for
example, by the Workflow service to determine what workflows to return in a
list for a given `access_token`.

The request body is a JSON dictionary with the following parameters:

- `access_token`
    - The Bearer token that is the subject of the query.

#### Responses
Success:

- HTTP 200 (OK)
    - Response body is a JSON dictionary with the following parameters:
        - `user_roles`
            - A list of roles associated with the `access_token`.

Error:

- HTTP 400 (Bad Request)
    - possible causes:
        - `access_token` is not associated with the requesting client
        - token is expired
        - no such token
        - invalid request body
- HTTP 401 (Unauthenticated)
    - Includes the header `WWW-Authenticate: Basic`.
- HTTP 403 (Not Authorized)
    - Invalid `Authorization` header.

### POST /represents
Allows clients to check whether an access token can "represent" another user.
Requires [HTTP Basic authentication][3] of the client.  This can be used, for
example, to determine whether shell command can be run as a particular user.

The request body is a JSON dictionary with the following parameters:

- `access_token`
    - The Bearer token that is the subject of the query.
- `represented_user`
    - The name of the user that is the subject of the query.

#### Responses

Success:

- HTTP 200 (OK)
    - The `access_token` can represent the user.

Error:

- HTTP 400 (Bad Request)
    - possible causes:
        - `access_token` is not associated with the requesting client
        - token is expired
        - no such token
        - invalid request body
- HTTP 401 (Unauthenticated)
    - Includes the header `WWW-Authenticate: Basic`.
- HTTP 403 (Not Authorized)
    - Invalid `Authorization` header.


## Client API
This section describes API endpoints for registering and modifying clients of
the auth server.

### POST /clients

Requires [HTTP Basic authentication][3] of the user.
Used directly by administrative users to register a new client, generating its
`client_id` and `client_secret` (if `confidential`).

Only `confidential` clients are allowed to use endpoints that require
authentication.

The request body is a JSON dictionary with the following parameters:

- `allowed_scopes`
    - List of scopes the client is allowed to request access to.
- `confidential`
    - boolean
    - defaults to true
- `default_scopes`
    - List of scopes the client should be granted access to if `scope` is
      omitted in a request to `/authorization`.
- `name`
    - string
- `redirect_uri_regex`
    - Regular expression for validating values of `redirtect_uri`.

#### Responses

Success:

- HTTP 201 (Created)
    - Respond with the full resource including `client_id` and, if
      `confidential` then `client_secret`.

Error:

- HTTP 400 (Bad Request)
    - possible causes:
        - Missing or invalid `redirect_uri_regex`.
        - Missing scope parameters.
- HTTP 401 (Unauthenticated)
    - Includes the header `WWW-Authenticate: Basic`.
- HTTP 403 (Not Authorized)
    - Invalid `Authorization` header.

### PUT /clients/(id)

Requires [HTTP Basic authentication][3] of the user.
Used directly by administrative users to update or invalidate a client and all
access tokens and authorization codes associated with it.


## User API
This section describes API endpoints for managing user credentials.

### POST /api-keys

Requires [HTTP Basic authentication][3] of the user.
Used directly by users to generate a new API key for themselves.  Invalidates
existing API keys, but not the access tokens or authorization codes associated
with them.

### PUT /api-keys/(key)

Requires [HTTP Basic authentication][3] of the user.
Used directly by users and administrative users to revoke a key and the access
tokens and authorization codes associated with it.

### PUT /users/(id)
Requires [HTTP Basic authentication][3] of the user.
Used directly by administrative users to revoke all API keys, access tokens and
authorization codes associated with a user.


## Resource Server API Considerations

When an entity attempts to access a Protected Resource without a Bearer token,
the hosting resource server should respond with 401 (Unauthorized) and the
`WWW-Authenticate` header set.  `scope` may be specified in the header as done
in the below example:

    HTTP/1.1 401 (Unauthorized)
    Cache-Control: no-store
    Pragma: no-cache
    Location: https://resource-server.edu/protected/resource
    WWW-Authenticate: Bearer realm="resource-server",
                             scope="protected resource scopes"


<!-- References -->
[1]: https://tools.ietf.org/html/rfc6749 "The OAuth 2.0 Authorization Framework"
[2]: https://tools.ietf.org/html/rfc6750 "The OAuth 2.0 Authorization Framework: Bearer Token Usage"
[3]: https://tools.ietf.org/html/rfc2617 "HTTP Authentication: Basic and Digest Access Authentication"
